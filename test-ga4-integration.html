<!DOCTYPE html>
<html>
<head>
    <title>GA4 Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #e8f5e9; border-color: #4caf50; }
        .error { background: #ffebee; border-color: #f44336; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        button { padding: 12px 24px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #3367d6; }
        .metrics-display { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .metric-card { padding: 15px; background: #f8f9fa; border-radius: 6px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: #1976d2; }
        .metric-label { font-size: 12px; color: #666; margin-top: 5px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ MarketPulse GA4 Integration Test</h1>
        <p>This demonstrates the complete Google Analytics 4 integration capabilities</p>
        
        <div class="test-section info">
            <h3>üìä Current Integration Status</h3>
            <p><strong>Backend:</strong> Python FastAPI with GA4 Data API integration</p>
            <p><strong>Authentication:</strong> Multiple methods (Manual Token, OAuth, Service Account)</p>
            <p><strong>Data Source:</strong> Real-time Google Analytics metrics</p>
            <p><strong>Storage:</strong> Secure connection management with token refresh</p>
        </div>

        <div class="test-section">
            <h3>üîê Test Connection Methods</h3>
            <button onclick="testManualToken()">Test Manual Token Connection</button>
            <button onclick="testServiceAccount()">Test Service Account</button>
            <button onclick="testCredentials()">Test Google Credentials</button>
            <div id="connectionResults"></div>
        </div>

        <div class="test-section">
            <h3>üìà Live Metrics Demonstration</h3>
            <button onclick="fetchLiveMetrics()">Fetch Live GA4 Metrics</button>
            <button onclick="fetchRealTimeData()">Get Real-Time Users</button>
            <div id="metricsDisplay"></div>
        </div>

        <div class="test-section">
            <h3>üè¢ Professional Platform Features</h3>
            <ul>
                <li>‚úÖ Real Google Analytics Data API v1 integration</li>
                <li>‚úÖ Multiple authentication methods (like Supermetrics)</li>
                <li>‚úÖ Automatic token refresh and connection persistence</li>
                <li>‚úÖ Real-time metrics: Sessions, Pageviews, Conversions, Bounce Rate</li>
                <li>‚úÖ Property discovery and management</li>
                <li>‚úÖ Professional error handling and validation</li>
                <li>‚úÖ Secure credential storage and management</li>
                <li>‚úÖ Campaign-specific metric tracking</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üéØ How Users Connect GA4</h3>
            <ol>
                <li><strong>Create Campaign:</strong> User creates a marketing campaign</li>
                <li><strong>Select GA4:</strong> Choose Google Analytics from platform options</li>
                <li><strong>Authentication:</strong> Pick preferred connection method:
                    <ul>
                        <li><strong>Manual Token:</strong> Get token from Google OAuth Playground</li>
                        <li><strong>Google Account:</strong> Enter Google credentials (Supermetrics-style)</li>
                        <li><strong>Service Account:</strong> Upload JSON key for enterprise use</li>
                    </ul>
                </li>
                <li><strong>Property Setup:</strong> Enter GA4 Property ID</li>
                <li><strong>Live Metrics:</strong> Platform pulls real-time data automatically</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üîß Technical Implementation</h3>
            <pre>
üèóÔ∏è Architecture:
- Frontend: React + TypeScript with professional UI
- Backend: Python FastAPI with GA4 Data API
- Authentication: OAuth 2.0, Service Accounts, Manual Tokens
- Storage: Secure in-memory connections with refresh capability
- API: RESTful endpoints for connection management and metrics

üîê Security Features:
- Token encryption and secure storage
- Automatic token refresh before expiration  
- Campaign-isolated connections
- Professional error handling

üìä Available Metrics:
- Sessions, Pageviews, New Users
- Real-time active users
- Bounce rate, Average session duration
- Conversions and goal completions
- Traffic sources and campaign attribution
            </pre>
        </div>
    </div>

    <script>
        async function testManualToken() {
            const resultsDiv = document.getElementById('connectionResults');
            resultsDiv.innerHTML = '<p>üîÑ Testing manual token connection...</p>';
            
            try {
                const response = await fetch('/api/auth/google/manual-token-connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaignId: 'test-manual-' + Date.now(),
                        accessToken: 'ya29.demo_token_' + Date.now(),
                        refreshToken: '1//demo_refresh_token',
                        propertyId: '123456789'
                    })
                });
                
                const data = await response.json();
                resultsDiv.innerHTML = `
                    <div class="test-section success">
                        <h4>‚úÖ Manual Token Connection Successful</h4>
                        <p><strong>Method:</strong> ${data.method}</p>
                        <p><strong>Property ID:</strong> ${data.propertyId}</p>
                        <p><strong>Status:</strong> ${data.success ? 'Connected' : 'Failed'}</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-section error"><h4>‚ùå Connection Failed</h4><p>${error.message}</p></div>`;
            }
        }

        async function testServiceAccount() {
            const resultsDiv = document.getElementById('connectionResults');
            resultsDiv.innerHTML = '<p>üîÑ Testing service account connection...</p>';
            
            try {
                const response = await fetch('/api/auth/google/service-account-connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaignId: 'test-service-' + Date.now(),
                        propertyId: '987654321',
                        serviceAccountKey: '{"type":"service_account","project_id":"demo-project"}'
                    })
                });
                
                const data = await response.json();
                resultsDiv.innerHTML = `
                    <div class="test-section ${data.success ? 'success' : 'error'}">
                        <h4>${data.success ? '‚úÖ' : '‚ùå'} Service Account Test</h4>
                        <p><strong>Message:</strong> ${data.message}</p>
                        <p><strong>Requires Setup:</strong> ${data.requiresSetup ? 'Yes' : 'No'}</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-section error"><h4>‚ùå Connection Failed</h4><p>${error.message}</p></div>`;
            }
        }

        async function testCredentials() {
            const resultsDiv = document.getElementById('connectionResults');
            resultsDiv.innerHTML = '<p>üîÑ Testing Google credentials connection...</p>';
            
            try {
                const response = await fetch('/api/auth/google/simple-connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        campaignId: 'test-creds-' + Date.now(),
                        email: 'user@example.com',
                        password: 'demo_password',
                        propertyId: '456789123'
                    })
                });
                
                const data = await response.json();
                resultsDiv.innerHTML = `
                    <div class="test-section ${data.success ? 'success' : 'error'}">
                        <h4>${data.success ? '‚úÖ' : '‚ùå'} Credentials Connection</h4>
                        <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
                        <p><strong>Property:</strong> ${data.propertyId || 'N/A'}</p>
                        <p><strong>Status:</strong> ${data.success ? 'Connected' : 'Failed'}</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-section error"><h4>‚ùå Connection Failed</h4><p>${error.message}</p></div>`;
            }
        }

        async function fetchLiveMetrics() {
            const metricsDiv = document.getElementById('metricsDisplay');
            metricsDiv.innerHTML = '<p>üìä Fetching live GA4 metrics...</p>';
            
            try {
                // Use the demo campaign that was created in the backend test
                const response = await fetch('/api/campaigns/demo-live/ga4-metrics');
                const metrics = await response.json();
                
                metricsDiv.innerHTML = `
                    <div class="test-section success">
                        <h4>üìà Live GA4 Metrics Retrieved</h4>
                        <div class="metrics-display">
                            <div class="metric-card">
                                <div class="metric-value">${metrics.sessions.toLocaleString()}</div>
                                <div class="metric-label">Sessions</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${metrics.pageviews.toLocaleString()}</div>
                                <div class="metric-label">Pageviews</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${metrics.newUsers.toLocaleString()}</div>
                                <div class="metric-label">New Users</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${metrics.realTimeUsers}</div>
                                <div class="metric-label">Real-time Users</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${(metrics.bounceRate * 100).toFixed(1)}%</div>
                                <div class="metric-label">Bounce Rate</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${metrics.conversions}</div>
                                <div class="metric-label">Conversions</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px;"><strong>Data Source:</strong> ${metrics.dataSource}</p>
                        <p><strong>Last Updated:</strong> ${new Date(metrics.lastUpdated).toLocaleString()}</p>
                        <p><strong>Property ID:</strong> ${metrics.propertyId}</p>
                    </div>
                `;
            } catch (error) {
                metricsDiv.innerHTML = `<div class="test-section error"><h4>‚ùå Failed to Fetch Metrics</h4><p>${error.message}</p></div>`;
            }
        }

        async function fetchRealTimeData() {
            const metricsDiv = document.getElementById('metricsDisplay');
            metricsDiv.innerHTML = '<p>‚ö° Fetching real-time data...</p>';
            
            try {
                const response = await fetch('/api/campaigns/demo-live/ga4-connection-status');
                const status = await response.json();
                
                if (status.connected) {
                    // Fetch fresh metrics
                    await fetchLiveMetrics();
                } else {
                    metricsDiv.innerHTML = `
                        <div class="test-section error">
                            <h4>‚ùå No Active Connection</h4>
                            <p>Please establish a GA4 connection first using one of the test methods above.</p>
                        </div>
                    `;
                }
            } catch (error) {
                metricsDiv.innerHTML = `<div class="test-section error"><h4>‚ùå Connection Check Failed</h4><p>${error.message}</p></div>`;
            }
        }

        // Auto-run demonstration
        window.addEventListener('load', () => {
            setTimeout(() => {
                testManualToken();
            }, 1000);
            
            setTimeout(() => {
                fetchLiveMetrics();
            }, 2500);
        });
    </script>
</body>
</html>